# 前言

Markowitz于1952年发表了《投资组合的选择》，开启了现代投资组合的时代。凡事一个做量化的人，基本上都知道均值方差和有效前沿。大部分的量化组合，都是基于这套理论发展而来的。那么，构建一个量化投资组合，需要三板斧：alpha信号、风险模型和优化器。然后设置好目标和约束，将它们丢掉优化器里求解就好了。本文不会介绍均值方差的理论，这在很多教科书上都有介绍，这里推荐Grinold的红宝书《主动投资组合管理》第14章。本文介绍在实际使用中，如何看待自己设置的约束条件。

不得不说，投资中往往有一些必要约束是不能打破的，例如在中国市场不能做空，因此需要设置long-only的约束。除此之外，还有一些不必要约束限制，例如设置某个行业的配置比重相比于基准配置的偏离度上界。投资者设置不必要约束的时候，一般是凭借着经验来设置，比如将上界设置成2%，3%，或者干脆不设置。但是如何衡量这里的2%好还是3%好，本文介绍一种定量的方法，由Robert A. Stubbs和Dieter Vandenbussche在2008年提出的方法[1]。

前文说到，构建量化组合的过程是，给定一个alpha信号，在设定优化目标的情况下，可以通过优化器将这个目标最大化或最小化，从而生成一个投资组合，因为没有添加约束，我们把它叫做无约束组合。在这个优化过程中，如果添加了一些约束条件，则生成的投资组合，有可能就和无约束组合不同，我们把他称为带约束组合。这种现象在学术上称为implementation inefficiency或opportunity cost。这里的implementation可以理解为我在把alpha信号**构建**成投资组合。inefficiency的含义则是，由于一些限制条件的存在，我的alpha信号**没有被充分**的表达出来。

# 问题描述

在人们进行量化组合构建的过程中，需要设定一个优化目标，这里我们用标准的均值方差模型
$$
\max \alpha^T x - \frac{1}{2}\lambda (x-b)^T Q (x-b) \tag{1}
$$
为了让问题描述起来更简单，这里忽略了实际情况可能要考虑的问题，例如交易成本。上面的式子是一个最大化问题，其中$x$表示要去求解的投资组合，是个未知向量，$b$是基准组合的持仓占比。最大化的目标是组合的预期收益率$α^T x$和预期跟踪误差$(x-b)^T V(x-b)$的差值。在预期跟踪误差前面增加的λ则是风险厌恶系数，该值越大，表明投资者越厌恶风险。

除了上述目标函数之外，人们往往会设定一些约束条件，常见的有个股持仓比例，股票总仓位，行业偏离度，风格偏离度等，都可以设置一个对应的上下限。除了这些约束以外，还有一些不可求导的约束，例如换手率约束，交易费用。

上文说到，当添加了约束条件后，可能会造成implementation inefficiency的问题，一般用Transfer coefficient(TC)来衡量表达程度。当无约束的情况下，$TC=1$，否则小于1。但是当添加了多个约束条件时，TC无法精确衡量出每个约束条件是如何限制alpha信号的表达，接下来我们从三个角度来看待这个问题。

# 约束归因

我们沿用标准的均值方差模型作为优化目标。不失一般性，我们将约束条件表达成
$$
g_i(x) \leq 0 \quad \forall i\in \mathcal{C} \tag{2}
$$
其中$\mathcal{C}$表示约束集合。虽然这里是不等式约束，但也可以是等式约束。这么写的目的是为了利用拉格朗日乘子法将约束条件放到目标函数中。因此，得到广义的拉格朗日函数
$$
L(x,\lambda)=\alpha^T x - \frac{1}{2}\lambda (x-b)^T Q (x-b) - \sum_{i\in \mathcal{C}}\lambda_i g_i(x) \tag{3}
$$
其中$\lambda$是拉格朗日乘子，其个数等于约束条件的个数。一般在求解此类问题时，是令$L(x,\lambda)$分别对$x$和$\lambda_i$求导，并令导数等于0。如果有不等式约束，则再结合KKT条件，可以将$x$和$\lambda_i$求解出来。为了叙述方便，我们定义$x^*$表示带约束最优组合，$x_{MV}^*$为无约束最优组合。

接下来我们将从三个角度来看待约束条件的作用。

### alpha分解

令式子$(3)$对$x$求偏导数，并令其等于0，整理后得到
$$
Q(x^*-b)=\alpha-\sum_{i\in \mathcal{C}}\lambda_i  \nabla g_i(x^*) \tag{4}
$$
这个式子的左边是隐含alpha信号。它的含义是，如果在无约束条件下，求解式子$(1)$，可以得到带约束组合。式子右边表示每个约束条件是如何影响原始的alpha信号的。

### 持仓分解

我们将式$(4)$的左右两边同时左乘$Q^{-1}$，得到
$$
(x^*-b)=Q^{-1}\alpha - \sum_{i\in \mathcal{C}}\lambda_i Q^{-1}\nabla g_i(x^*) \tag{5}
$$
等式左边表示带约束组合关于基准$b$的主动投资组合。等式右边的$Q^{-1}\alpha $表示无约束组合的主动投资组合，即$x_{MV}^*-b$，而每一项$\lambda_i Q^{-1}\nabla g_i(x^*)$则表示了每个约束条件在持仓层面的分解。两边同时消去$b$，可以得到式子
$$
x^*=x_{MV}^* - \sum_{i\in \mathcal{C}}\lambda_i Q^{-1}\nabla g_i(x^*) \tag{6}
$$

### 预期收益率分解

我们定义组合的预期收益率为组合的持仓对alpha信号的加权求和，即$\alpha^Tx$。那么在式$(5)$的左右两边同时左乘以$\alpha^T$，就可以得到约束条件对预期收益率的分解。
$$
\alpha^T x^* = \alpha^T x_{MV}^* -\sum_{i\in \mathcal{C}}\lambda_i \alpha^T Q^{-1}\nabla g_i(x^*) \tag{6}
$$
至此我们介绍了三种角度去看待约束条件带来的影响，具体实证可以参考这个[notebook](https://github.com/Casey1203/axioma-paper/blob/master/constraint%20attribution.ipynb)

### 不可导约束条件

前文说到，有一些约束条件无法求导数，这里我们用交易费用作为例子
$$
c^T|x-h|\leq t \tag{7}
$$
其中$h$表示优化前的投资组合，$c$表示每个股票的交易费率，$t$为费用上限。这个约束中，当$x_i=h_i$的时候，函数是不光滑的，因此需要求解次梯度。我们同样使用拉格朗日乘子法，对$x$求偏导数，令其等于0，只不过需要写成下面的形式
$$
\alpha - Qx^* - s = 0 \tag{8}
$$
其中$s$表示次梯度，其形式为
$$
s_{i} \in\left\{\begin{array}{ll}{\left\{-c_{i} \lambda\right\}} & {\text { if } x_{i}^{*}<h_{i}} \\ {\left[-c_{i} \lambda, c_{i} \lambda\right]} & {\text { if } x_{i}^{*}=h_{i}} \\ {\left\{c_{i} \lambda\right\}} & {\text { if } x_{i}^{*}>h_{i}}\end{array}\right.
$$
需要解决当$x_i^*=h_i$的情况。我们通过求解一个二阶优化问题，在区间${\left[-c_{i} \lambda, c_{i} \lambda\right]}$中选择一个合适的值。还有一些约束条件本身非凸，例如含有投资个数上限要求的约束。这些在这里就不展开，放到之后再讲。

# 总结

在实际的量化组合构建过程中，约束条件起到的作用不亚于优化目标，并且为了构建出更好的组合，约束条件会经过反复的调整。我们通过三个角度，系统的分析了约束条件如何在优化投资组合的过程中起到的作用。其意义在于，不仅可以帮助用户看清楚约束条件的影响细节，同时还能反过来指导用户该如何选择和调节约束条件，从而更好地帮助用户进行组合构建。